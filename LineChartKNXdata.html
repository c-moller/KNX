<!DOCTYPE html>
<html>
<head>
	<!--Load the AJAX API-->
	<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

  <script type="text/javascript">
  	function ShowForm() {
    	var x = document.getElementById("hiddenForm");
   		if (x.style.display === "none") {
    	    x.style.display = "block";
    	} else {
    	    x.style.display = "none";
    	}
	}

	function loadGraphs(){
		console.log("--------------------------------------------------------------------------------------");
		function clearDivs(){
    		document.getElementById("item2").innerHTML = "";
			document.getElementById("item4").innerHTML = "";
			document.getElementById("item6").innerHTML = "";
			document.getElementById("item8").innerHTML = "";
			document.getElementById("item10").innerHTML = "";
			document.getElementById("item12").innerHTML = "";
			document.getElementById("item14").innerHTML = "";
			document.getElementById("item16").innerHTML = "";
			document.getElementById("item1").innerHTML = "";
			document.getElementById("item3").innerHTML = "";
			document.getElementById("item5").innerHTML = "";
			document.getElementById("item7").innerHTML = "";
			document.getElementById("item9").innerHTML = "";
			document.getElementById("item11").innerHTML = "";
			document.getElementById("item13").innerHTML = "";
			document.getElementById("item15").innerHTML = "";
		}

   		 /*Convert Time */
    	var startTime = function(period) {
        	var startDate = new Date();
        	switch (period){
            	case 'h': startDate.setTime(startDate.getTime() - 60*60*1000); break;
            	case '4h': startDate.setTime(startDate.getTime() - 4*60*60*1000); break;
            	case '8h': startDate.setTime(startDate.getTime() - 8*60*60*1000); break;
            	case '12h': startDate.setTime(startDate.getTime() - 12*60*60*1000); break;
            	case 'D': startDate.setTime(startDate.getTime() - 24*60*60*1000); break;
            	case '3D': startDate.setTime(startDate.getTime() - 3*24*60*60*1000); break;
            	case 'W': startDate.setTime(startDate.getTime() - 7*24*60*60*1000); break;
            	case '2W': startDate.setTime(startDate.getTime() - 2*7*24*60*60*1000); break;
            	case 'M': startDate.setTime(startDate.getTime() - 31*24*60*60*1000); break; //Well...
            	case '2M': startDate.setTime(startDate.getTime() - 2*31*24*60*60*1000); break;
            	case '4M': startDate.setTime(startDate.getTime() - 4*31*24*60*60*1000); break;
            	case 'Y': startDate.setTime(startDate.getTime() - 12*31*24*60*60*1000); break;
            	default: startDate.setTime(startDate.getTime() - 24*60*60*1000); break;
        	}
        	return startDate;
   		}
   		/*Get time period based on user input */
    	var Type_format;
    	var period = document.getElementById("TimeSelect").value;
    	switch (period){
        	case 'h': Type_format='HH:mm'; break;
        	case '4h': Type_format= 'HH:mm'; break;
        	case '8h': Type_format= 'HH:mm'; break;
        	case '12h': Type_format= 'HH:mm'; break;
        	case 'D': Type_format= 'HH:mm'; break;
        	case '3D': Type_format= 'EEE HH:mm'; break;
        	case 'W': Type_format= 'EEE dd/MM'; break;
        	case '2W': Type_format= 'EEE dd/MM'; break;
        	case 'M': Type_format= 'EEE dd/MM'; break;
        	case '2M': Type_format= 'dd/MM'; break;
        	case '4M': Type_format= 'MMM'; break;
        	case 'Y': Type_format= 'MMM'; break;
        	default: Type_format= 'EEE dd/MM'; break;
    	}

    	var ColorScheme=[];
    	var hexSelect = document.getElementById("ColorSelect").value;
    	switch (hexSelect){
        	case 'KNX': ColorScheme=['#2196F3', '#2EA443','#134EDC','#43F062','#13B8DC']; break;
        	case 'red': ColorScheme= ['#F44336', '#74201A','#C1352B','#F68880','#DD2656']; break;
        	case 'blue': ColorScheme= ['#2196F3', '#134EDC','#13B8DC','#151CFA','#15FAE5']; break;
        	case 'green': ColorScheme= ['#2EA443', '#43F062','#20712E','#68B375','#8CF09E']; break;
        	default: ColorScheme= ['#2196F3', '#2EA443','#134EDC','#43F062','#13B8DC']; break;
    	}
    	
//Compute Start UNIX time
		var startDate = startTime(period);
		var Time_Data = startDate.getTime();
		console.log("Time Data: " + Time_Data + ", " + period + ", " + startDate);
		//Load items page for subnet
		var loadhttp;
		loadhttp = new XMLHttpRequest();
		loadhttp.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200) {
				readItems(this);
			}
		};
		loadhttp.open("GET", "/rest/items", true);
		loadhttp.send();
		//Load items page for subnet and find items with StateDescription(can plot) and without
		function readItems(doc) {
			var JsonDoc, i, txt, ArrayDoc;
			var NameUnits = [];
			var units = [];
			var LabelUnits = [];
			var LinkUnits = [];
			var NameNoUnit = [];
			var LabelNoUnit = [];
			var LinkNoUnit = [];
			ArrayDoc = doc.responseText;
			txt = "";
			JsonDoc = JSON.parse(ArrayDoc);
			for (var i = 0; i < JsonDoc.length; i++) {
				if (JsonDoc[i].stateDescription !== undefined) {
					NameUnits.push(JsonDoc[i].name);
					units.push(JsonDoc[i].stateDescription.pattern);
					LabelUnits.push(JsonDoc[i].label);
					LinkUnits.push(JsonDoc[i].link);
				} else {
					NameNoUnit.push(JsonDoc[i].name);
					LabelNoUnit.push(JsonDoc[i].label);
					LinkNoUnit.push(JsonDoc[i].link);
				}
			}
			sortUnit(NameUnits, units, LabelUnits, LinkUnits);
			console.log("Loaded realKNX items")
			clearDivs();
		}

		var object = this;
		//Sort variables per unit type
		function sortUnit(SeriesName, unit, Label, links) {
			var Type_format, testString1,testString2,index2,index;
			var roomName=[];
			//Read user selected unit
			var unitString = document.getElementById("UnitSelect").value;
			var roomSelectString = document.getElementById("RoomSelect").value;
			object.SeriesName = [];
			object.Label = [];
			object.link = [];
			object.ylabel=[];
			for(k=0; k<Label.length; k++){
				if (Label[k] !== undefined) {
					index = Label[k].indexOf(" - ");
					roomName[k]= Label[k].substr(0, index);
				}
			}

			for (i = 0; i < unit.length; i++) {
				if (unitString=="All" && roomSelectString=="All"){
					object.SeriesName.push(SeriesName[i]);
					object.Label.push(Label[i]);
					object.link.push(links[i]);
					if (unit[i] !== undefined) {
						index2 = unit[i].indexOf(" ");
						ylabel.push(unit[i].substr(index2+1));
					}
				//Display all rooms for selected unit
				}else if(roomSelectString=="All"){
					//Symbol Â° not readable so sort Weather variables using label; "Weather - ..."
					if (Label[i] !== undefined) {
						index = Label[i].indexOf(" - ");  // Gets the first index where a space occours
						testString1 = Label[i].substr(0, index); // Gets the first part
						testString2 = Label[i].substr(index + 3); 
					} 
					if (unit[i] !== undefined && unit[i].toUpperCase()==unitString.toUpperCase()) {
						object.SeriesName.push(SeriesName[i]);
						object.Label.push(Label[i]);
						object.link.push(links[i]);
						index2 = unit[i].indexOf(" ");
						ylabel.push(unit[i].substr(index2+1));
					} else if (testString1.toUpperCase() == unitString.toUpperCase()) {
						object.SeriesName.push(SeriesName[i]);
						object.Label.push(Label[i]);
						object.link.push(links[i]);
						if (unit[i] !== undefined) {
							index2 = unit[i].indexOf(" ");
							ylabel.push(unit[i].substr(index2+1));
						}
					}else if (testString2.toUpperCase()==unitString.toUpperCase()) {
						object.SeriesName.push(SeriesName[i]);
						object.Label.push(Label[i]);
						object.link.push(links[i]);
						if (unit[i] !== undefined) {
							index2 = unit[i].indexOf(" ");
							ylabel.push(unit[i].substr(index2+1));
						}
					}
				// Display all units for selected room items
				}else if(unitString=="All"){
					if (roomName[i]==roomSelectString) {
						object.SeriesName.push(SeriesName[i]);
						object.Label.push(Label[i]);
						object.link.push(links[i]);
						index2 = unit[i].indexOf(" ");
						ylabel.push(unit[i].substr(index2+1));
					}
				//Display selected room and unit 
				}else{
					if (Label[i] !== undefined) {
						index = Label[i].indexOf(" - ");  // Gets the first index where a space occours
						testString1 = Label[i].substr(0, index); // Gets the first part
						testString2 = Label[i].substr(index + 3); 
					}
					if (roomName[i]==roomSelectString) {
						if(unit[i].toUpperCase()==unitString.toUpperCase() && unit[i]!==undefined){
							object.SeriesName.push(SeriesName[i]);
							object.Label.push(Label[i]);
							object.link.push(links[i]);
							index2 = unit[i].indexOf(" ");
							ylabel.push(unit[i].substr(index2+1));	
						}else if (testString1.toUpperCase()==unitString.toUpperCase()) {
							object.SeriesName.push(SeriesName[i]);
							object.Label.push(Label[i]);
							object.link.push(links[i]);
							if (unit[i] !== undefined) {
								index2 = unit[i].indexOf(" ");
								ylabel.push(unit[i].substr(index2+1));
							}
						}else if (testString2.toUpperCase()==unitString.toUpperCase()) {
							object.SeriesName.push(SeriesName[i]);
							object.Label.push(Label[i]);
							object.link.push(links[i]);
							if (unit[i] !== undefined) {
								index2 = unit[i].indexOf(" ");
								ylabel.push(unit[i].substr(index2+1));
							}
						}else{
							console.log("No data for selected room and units");
						}
					}
				}
			}
			console.log("Selected Label: " + object.Label);
			console.log("ylabel: "+ object.ylabel);
			getData(object.link, object.SeriesName, object.Label,object.ylabel);
		}
		//Open XML file for the selected datasets
		function getData(link, NameSeries, label,ylabel) {
			var v = 0;
			for (i = 0; i < label.length; i++) {
				var xhttp;
				xhttp = new XMLHttpRequest();
				//'http://192.168.1.57:8081/services/habmin/persistence/services/rrd4j/'
				xhttp.open("GET", link[i] + NameSeries[i] + "?starttime=" + Time_Data, true);
				xhttp.send();
				xhttp.onreadystatechange = function() {
					if (this.readyState == 4 && this.status == 200) {
						readXML(this, v, label, NameSeries,ylabel);
						v++;
					}
				};
			}
		}
		var totalState = [];
		var count;
		//read time point data and sort for line plot
		function readXML(xml, k, label, NameSeries,ylabel) {
			var finaldata, seriesname, i, txt, xmlDoc, ChartDiv, unitSelect, ChartTitle, DivSelect, ChartColor,AxisLabel;
			var state = [];
			var date = [];
			var tps = [];
			var stt = [];
			var time = [];
			xmlDoc = xml.responseXML;
			txt = "";
			var seriesname = xmlDoc.getElementsByTagName("name");
			var series = seriesname[0].innerHTML;
			//Give Label to data and select correct div placement
			for (i = 0; i < NameSeries.length; i++) {
				if (series == NameSeries[i]) {
					ChartTitle = label[i];
					AxisLabel = ylabel[i];
					DivSelect = i;
				}
			}
			//Convert XML data to chart values
			finaldata = xmlDoc.getElementsByTagName("data");
			if (finaldata.length > 1) {
				t = xmlDoc.getElementsByTagName("time");
				st = xmlDoc.getElementsByTagName("state");
				for (j = 0; j < finaldata.length; j++) {
					date[j] = new Date();
					time[j] = t[j].innerHTML;
					tps[j] = parseFloat(time[j]);
					date[j].setTime(time[j]);
					stt[j] = st[j].innerHTML;
					state[j] = parseFloat(stt[j]);
				}
			}
			//Select chart placement and color scheme
			switch (DivSelect) {
				case 0:ChartDiv = 'item1'; ChartColor=ColorScheme[0]; break;
				case 1:ChartDiv = 'item2'; ChartColor=ColorScheme[1]; break;
				case 2:ChartDiv = 'item3'; ChartColor=ColorScheme[2]; break;
				case 3:ChartDiv = 'item4'; ChartColor=ColorScheme[3]; break;
				case 4:ChartDiv = 'item5'; ChartColor=ColorScheme[0]; break;
				case 5:ChartDiv = 'item6'; ChartColor=ColorScheme[2]; break;
				case 6:ChartDiv = 'item7'; ChartColor=ColorScheme[1]; break;
				case 7:ChartDiv = 'item8'; ChartColor=ColorScheme[3]; break;
				case 8:ChartDiv = 'item9'; ChartColor=ColorScheme[0]; break;
				case 9:ChartDiv = 'item10'; ChartColor=ColorScheme[1]; break;
				case 10:ChartDiv = 'item11'; ChartColor=ColorScheme[2]; break;
				case 11:ChartDiv = 'item12'; ChartColor=ColorScheme[3]; break;
				case 12:ChartDiv = 'item13'; ChartColor=ColorScheme[0]; break;
				case 13:ChartDiv = 'item14'; ChartColor=ColorScheme[2]; break;
				case 14:ChartDiv = 'item15'; ChartColor=ColorScheme[1]; break;
				case 15:ChartDiv = 'item16'; ChartColor=ColorScheme[3]; break;
				default:ChartDiv = 'chartdiv'; ChartColor=ColorScheme[0]; break;
			}
			drawChart(date, state, ChartDiv, ChartTitle, ChartColor, AxisLabel);
			//Draw Special charts
			unitSelect = document.getElementById("UnitSelect").value;
			var cmpString="%.2f kW";
			if(unitSelect.toUpperCase()==cmpString.toUpperCase()){
				count = 0;
				for (i = state.length; i--;) {
					count += state[i];
				}
				totalState[DivSelect]=count;
				if (totalState.length>2){
   					totalState[3]=totalState[0]-totalState[1]-totalState[2];
   					DrawPie(totalState, ColorScheme);
   					console.log("Draw Pie");
   				}
			}
			else{
				document.getElementById("SpecialChartDiv").innerHTML = "";
			}
			
		}
		// Load the Visualization API		
		function drawChart(date, state, ChartDiv, label,ChartColor,ylabel) {
			google.charts.load('current', {
				packages: ['corechart']
			});
			// Set a callback to run when the Google Visualization API is loaded.
			google.charts.setOnLoadCallback(drawChart);
			//Line Chart with zoom
			function drawChart() {
				var data = new google.visualization.DataTable();
				data.addColumn('datetime', 'Time of Day');
				data.addColumn('number', ylabel);
				for (i = 0; i < date.length; i++) {
					data.addRow([date[i], state[i]]);
				}
				var options = {
					legend: 'none',
					title: label,
					backgroundColor: { 
						fill:'transparent' 
					},
					hAxis: {
						format: Type_format,
						titleTextStyle: {
							color: '#333'
						}
					},
					vAxis: {
						title: ylabel,
						minValue: 0
					},
					explorer: {
						actions: ['dragToZoom', 'rightClickToReset'],
						axis: 'horizontal',
						keepInBounds: true,
						maxZoomIn: 4.0
					},
					colors: [ChartColor],
				};
				var chart = new google.visualization.LineChart(document.getElementById(ChartDiv));
				chart.draw(data, options);
			}
		}

		function DrawPie(State,colorScheme) {
			google.charts.load('current', {
				packages: ['corechart']
			});
			google.charts.setOnLoadCallback(ChartPie);

			function ChartPie() {
				// Define the chart to be drawn.
				var data = new google.visualization.DataTable();
				data.addColumn('string', 'Type');
				data.addColumn('number', 'kW');
				data.addRows([
					['Convecteur', State[1]],
					['Eclairage', State[2]],
					['Autre', State[3]],
				]);
				// Set chart options
				var options = {
					'title': 'How much am I consumming?',
					'backgroundColor': { 
						'fill':'transparent' },
					colors: [colorScheme[1], colorScheme[2], colorScheme[0]]
				};
				// Instantiate and draw the chart.
				var chart = new google.visualization.PieChart(document.getElementById('SpecialChartDiv'));
				chart.draw(data, options);
			}
		}
	}

	loadGraphs();

	//Get Room names from subnet items page
	var loadhttp;
	loadhttp = new XMLHttpRequest();
	loadhttp.onreadystatechange = function() {
		if (this.readyState == 4 && this.status == 200) {
			readItems(this);
		}
	};
	loadhttp.open("GET", "/rest/items", true);
	loadhttp.send();
	function readItems(doc) {
		var JsonDoc, i,j, txt, ArrayDoc;
		var NameUnits = [];
		var units = [];
		var LabelUnits = [];
		var LinkUnits = [];
		ArrayDoc = doc.responseText;
		txt = "";
		JsonDoc = JSON.parse(ArrayDoc);
		for (var i = 0; i < JsonDoc.length; i++) {
			if (JsonDoc[i].stateDescription !== undefined) {
				NameUnits.push(JsonDoc[i].name);
				units.push(JsonDoc[i].stateDescription.pattern);
				LabelUnits.push(JsonDoc[i].label);
				LinkUnits.push(JsonDoc[i].link);
			} 
		}
		var index;
		var roomString=[];
		var unitString=[];
		for (i = 0; i < LabelUnits.length; i++) {
			if (LabelUnits[i] !== undefined) {
				index = LabelUnits[i].indexOf(" - ");  // Gets the first index where a space occours
				roomString[i] = LabelUnits[i].substr(0, index); // Gets the first part				
    		}	
		}
		//Write room and unit label into drop-down
		var roomStringSort = roomString.sort();
		var x = document.createElement("OPTION");
   		x.setAttribute("value", roomString[0]);
    	var t = document.createTextNode(roomString[0]);
    	x.appendChild(t);
    	document.getElementById("RoomSelect").appendChild(x);
				
		for (j=1;j<roomString.length;j++){
			var compare = roomString[j-1]==roomString[j];
			if(compare==false){
				var x = document.createElement("OPTION");
   				x.setAttribute("value", roomString[j]);
    			var t = document.createTextNode(roomString[j]);
    			x.appendChild(t);
    			document.getElementById("RoomSelect").appendChild(x);
			}
		}
		console.log("Loaded Room names");
	}
	</script>

</head>

<body>

	<div class="row">
		<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
			<div class="col-lg-8 col-md-8 col-sm-8 col-xs-8">
				<h2> Visualise KNX data </h2>
			</div>
			<div class="col-lg-4 col-md-4 col-sm-4 col-xs-4 text-right">
				<button onclick="ShowForm()" class="btn pull-right"><img src="/pics/Palette-btn.png"></button>
				<form id="hiddenForm" style="display: none">
					<div class="form-group pull-right" style="width:50%">
						<select id="ColorSelect" class="form-control" onchange="loadGraphs()">
							<option value="KNX">Default</option>
							<option value="red">Red</option>
							<option value="blue">Blue</option>
							<option value="green">Green</option>
						</select>
					</div>
				</form>
			</div>
		</div>
		<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
			<div class="col-lg-4 col-md-4 col-sm-4 col-xs-4" >
				<form>
					<div class="form-group">
						<p>Select room:</p>
						<select id="RoomSelect" class="form-control" onchange="loadGraphs()">
							<option value="All">All</option>
						</select>
					</div>
				</form>
			</div>
			<div class="col-lg-4 col-md-4 col-sm-4 col-xs-4" >
				<form>
					<div class="form-group">
						<p>Select type:</p>
						<select id="UnitSelect" class="form-control" onchange="loadGraphs()">
							<option value="All">All</option>
							<option value="%.2f kW">kW</option>
							<option value="Weather">Weather</option>
							<option value="%d">Decimal</option>
							<option value="Thermostat">Thermostat</option>
							<option value="Volume">Volume</option>
						</select>
					</div>
				</form>
			</div>
			<div class="col-lg-4 col-md-4 col-sm-4 col-xs-4">
				<form>
					<div class="form-group">
						<p>Select period:</p>
						<select id="TimeSelect" class="form-control" onchange="loadGraphs()">
							<option value="W"> Week</option>
							<option value="3D">3 Days</option>
							<option value="D">1 Day</option>
							<option value="12h">12 Hours</option>
							<option value="8h">8 Hours</option>
							<option value="4h">4 Hours</option>
							<option value="h">1 Hour</option>
							<option value="2W">2 Weeks</option>
							<option value="M">Month</option>
							<option value="2M">2 Months</option>
							<option value="4M">4 Months</option>
							<option value="Y">Year</option>
					</select>
				</div>
				</form>
			</div>
		</div>

		<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
			<div class="col-lg-6 col-md-6 col-sm-12 col-xs-12">
				<div id="item1" style="width:auto"></div>
				<div id="item3" style="width:auto"></div>
				<div id="item5"></div>
				<div id="item7"></div>
				<div id="item9"></div>
				<div id="item11"></div>
				<div id="item13"></div>
				<div id="item15"></div>
			</div>
			<div class="col-lg-6 col-md-6 col-sm-12 col-xs-12">
				<div id="item2" style="width:auto"></div>
				<div id="item4" style="width:auto"></div>
				<div id="item6"></div>
				<div id="item8"></div>
				<div id="item10"></div>
				<div id="item12"></div>
				<div id="item14"></div>
				<div id="item16"></div>
			</div>
		</div>
		<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
			<div class="col-lg-6 col-md-6 col-sm-12 col-xs-12">
				<div id="SpecialChartDiv"></div>
			</div>
			<div class="col-lg-6 col-md-6 col-sm-12 col-xs-12">
				<div id="chartdiv"></div>
			</div>
		</div>

</body>

</html>
